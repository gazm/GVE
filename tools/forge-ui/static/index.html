<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GVE Forge - The Iron Forge</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/forms.css">
    <link rel="stylesheet" href="/static/css/library.css">
    <link rel="stylesheet" href="/static/css/studio-layout.css">
    <link rel="stylesheet" href="/static/css/studio-components.css">
    <link rel="stylesheet" href="/static/css/studio-tree.css">
    <link rel="stylesheet" href="/static/css/studio-world.css">
    <link rel="preload" href="/static/wasm/pkg/gve_wasm_bg.wasm" as="fetch" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Outfit:wght@400;700&display=swap"
        rel="stylesheet">

</head>

<body class="dark-theme">
    <nav class="top-nav">
        <div class="logo">
            <span class="accent">GVE</span> Forge
        </div>
        <div class="nav-links">
            <button class="nav-btn" data-page="genai" onclick="showPage('genai')">GenAI</button>
            <button class="nav-btn" data-page="asset-editor" onclick="showPage('asset-editor')">Asset Editor</button>
            <button class="nav-btn" data-page="world" onclick="showPage('world')">World</button>
            <button class="nav-btn active" data-page="library" onclick="showPage('library')">Library</button>
        </div>
        <div class="status-indicators">
            <div class="status-indicator" id="status-architect">
                <span class="dot pulse"></span> Architect Online
            </div>
            <div class="status-indicator" id="status-torch">
                <span class="dot torch-dot cold"></span> <span class="torch-label">Torch Cold</span>
            </div>
        </div>
    </nav>

    <!-- Shared Viewport Section (always visible) -->
    <section class="shared-viewport-container">
        <canvas id="shared-viewport"></canvas>
    </section>

    <!-- Page: GenAI (AI Generation) - Side Panels Only -->
    <main id="page-genai" class="genai-studio page" style="display: none;">
        <!-- Left: Generation Controls -->
        <aside class="studio-panel genai-panel-left">
            <header class="panel-header">
                <h2>Generate</h2>
            </header>
            <div class="panel-content">
                <!-- Content skipped for brevity -->
                <!-- Asset Type Selector -->
                <div class="form-group">
                    <label>Asset Type</label>
                    <div class="type-selector">
                        <button class="type-btn active" data-type="prop">Prop</button>
                        <button class="type-btn" data-type="weapon">Weapon</button>
                        <button class="type-btn" data-type="vehicle">Vehicle</button>
                        <button class="type-btn" data-type="character">Character</button>
                    </div>
                </div>

                <!-- Prompt Input -->
                <div class="form-group">
                    <label for="ai-prompt">Describe your asset</label>
                    <textarea id="ai-prompt" class="prompt-input" rows="3"
                        placeholder="e.g., rusty AK-47 with wooden stock"></textarea>
                </div>

                <!-- Style Options -->
                <div class="form-group">
                    <label>Style</label>
                    <div class="style-chips">
                        <button class="chip" data-style="realistic">Realistic</button>
                        <button class="chip active" data-style="stylized">Stylized</button>
                        <button class="chip" data-style="worn">Worn</button>
                        <button class="chip" data-style="pristine">Pristine</button>
                    </div>
                </div>

                <!-- Quality / Resolution Slider -->
                <div class="form-group">
                    <div class="label-row">
                        <label>Quality</label>
                        <span id="quality-value" class="slider-value">Standard</span>
                    </div>
                    <input type="range" id="ai-quality" class="slider" min="0" max="3" step="1" value="1">
                    <div class="slider-labels">
                        <span>Draft</span>
                        <span>Std</span>
                        <span>High</span>
                        <span>Ultra</span>
                    </div>
                </div>

                <!-- Material Suggestion -->
                <div class="form-group">
                    <label>Suggested Materials</label>
                    <div id="material-suggestions" class="material-chips">
                        <span class="chip-placeholder">Enter a prompt to see suggestions...</span>
                    </div>
                </div>

                <!-- Workflow Mode Toggle -->
                <div class="form-group workflow-mode">
                    <label class="toggle-label">
                        <input type="checkbox" id="skip-concept" class="toggle-checkbox">
                        <span class="toggle-text">Skip concept preview (direct 3D)</span>
                    </label>
                </div>

                <!-- Generate Button -->
                <button id="btn-generate" class="btn-generate" onclick="generateAsset()">
                    <span class="icon">üé®</span> <span id="btn-generate-text">Generate Concept</span>
                </button>

                <!-- Cost Estimate -->
                <div class="cost-estimate">
                    <span class="estimate-label">Estimated:</span>
                    <span class="estimate-cost" id="cost-estimate">$0.00</span>
                    <span class="estimate-time">~0s</span>
                </div>

                <!-- Stage Progress Indicator (3D Generation) -->
                <div id="stage-progress" class="stage-progress" style="display: none;">
                    <div class="stage-progress-header">
                        <span class="stage-progress-label">Generating 3D Asset</span>
                    </div>
                    <div class="stage-progress-items">
                        <div class="stage-item pending" data-stage="A1">
                            <span class="stage-icon">1</span>
                            <span class="stage-name">Form</span>
                            <span class="stage-status"></span>
                        </div>
                        <div class="stage-connector"></div>
                        <div class="stage-item pending" data-stage="A2">
                            <span class="stage-icon">2</span>
                            <span class="stage-name">Details</span>
                            <span class="stage-status"></span>
                        </div>
                        <div class="stage-connector"></div>
                        <div class="stage-item pending" data-stage="A3">
                            <span class="stage-icon">3</span>
                            <span class="stage-name">Materials</span>
                            <span class="stage-status"></span>
                        </div>
                    </div>
                </div>

                <!-- Concept Preview Container (Two-Phase Workflow) -->
                <div id="concept-preview" class="concept-preview" style="display: none;">
                    <div class="concept-preview-header">
                        <h4>üé® Concept Preview</h4>
                        <p id="concept-prompt-display" class="concept-prompt"></p>
                    </div>
                    <div class="concept-image-container">
                        <img id="concept-image" src="" alt="Concept preview" class="concept-image">
                    </div>
                    <div class="concept-actions">
                        <button class="btn btn-primary" id="btn-approve-concept">
                            <span class="icon">‚úÖ</span> Approve & Generate 3D
                        </button>
                        <button class="btn btn-secondary" id="btn-regenerate-concept">
                            <span class="icon">üîÑ</span> Regenerate
                        </button>
                        <button class="btn btn-ghost" id="btn-cancel-concept">
                            <span class="icon">‚ùå</span> Cancel
                        </button>
                    </div>
                </div>

                <!-- Regenerate Feedback Dialog -->
                <div id="regenerate-dialog" class="regenerate-dialog" style="display: none;">
                    <div class="dialog-header">
                        <h4>üîÑ Regenerate Concept</h4>
                    </div>
                    <div class="dialog-content">
                        <label for="regenerate-feedback">What would you like to change?</label>
                        <textarea id="regenerate-feedback" class="prompt-input" rows="2" 
                            placeholder="e.g., make it more rusty, add more detail, change the angle..."></textarea>
                    </div>
                    <div class="dialog-actions">
                        <button class="btn btn-primary" id="btn-submit-regenerate">Regenerate</button>
                        <button class="btn btn-ghost" id="btn-cancel-regenerate">Cancel</button>
                    </div>
                </div>
            </div>
            <div class="resize-handle handle-right"></div>
        </aside>

        <!-- Center: Viewport overlay (stats, mode buttons, view cube) -->
        <div class="viewport-cell" style="grid-area: genai-viewport;">
            <div class="viewport-stats">
                <span id="fps">60 FPS</span>
                <span id="tri-count">SDF Evaluation</span>
            </div>
            <div class="viewport-modes">
                <button class="mode-btn active" data-mode="sdf" title="SDF Source">‚óá</button>
                <button class="mode-btn" data-mode="shell" title="Shell Mesh">‚ñ≥</button>
                <button class="mode-btn" data-mode="splat" title="Splat View">‚óè</button>
                <button class="mode-btn" data-mode="physics" title="Physics Debug">‚òê</button>
                <button class="mode-btn" onclick="clearViewportManual()" title="Clear Viewport">√ó</button>
                <button class="mode-btn" onclick="openExternalViewport()" title="Open Dedicated Viewport">‚ó≥</button>
            </div>
        </div>

        <!-- Right: Output & Feedback -->
        <aside class="studio-panel genai-panel-right">
            <div class="resize-handle handle-left"></div>
            <!-- Generation Output Log -->
            <div class="output-section">
                <header class="output-header">
                    <h3>Output</h3>
                    <button class="btn-icon-sm" title="Clear log" onclick="clearOutput()">√ó</button>
                </header>
                <div id="generation-output" class="output-log">
                    <p class="output-empty">Generation output will appear here...</p>
                </div>
            </div>

            <!-- Feedback & Save UI (Hidden by default) -->
            <div id="feedback-container" class="feedback-panel" style="display: none;">
                <div class="rating-box">
                    <span>Rate:</span>
                    <button class="star-btn" onclick="rateAsset(1)">‚òÖ</button>
                    <button class="star-btn" onclick="rateAsset(2)">‚òÖ</button>
                    <button class="star-btn" onclick="rateAsset(3)">‚òÖ</button>
                    <button class="star-btn" onclick="rateAsset(4)">‚òÖ</button>
                    <button class="star-btn" onclick="rateAsset(5)">‚òÖ</button>
                </div>
                <button id="btn-save-draft" class="btn-primary btn-sm" onclick="saveAsset()">Save to Library</button>
                <button id="btn-add-to-chain" class="btn-accent btn-sm" onclick="switchToAssetEditor()"
                    style="display: none;">Add to Chain</button>
            </div>
        </aside>
    </main>

    <!-- Page: Asset Editor (Composition Studio) - Side Panels Only -->
    <main id="page-asset-editor" class="asset-studio page" style="display: none;">
        <!-- Left: Hierarchy Panel -->
        <aside class="studio-panel hierarchy-panel">
            <header class="panel-header">
                <h2>Hierarchy</h2>
                <div class="panel-actions">
                    <button class="btn-icon-sm" onclick="showLibraryPicker()" title="Add Asset">+</button>
                    <button class="btn-icon-sm" onclick="compileChain()" title="Compile">‚ö°</button>
                </div>
            </header>
            <div id="tree-viewer" class="panel-content tree-panel" hx-get="/api/assets/partials/tree" hx-trigger="load"
                hx-swap="innerHTML">
                <p class="empty-state">Loading‚Ä¶</p>
            </div>
            <div class="resize-handle handle-right"></div>
        </aside>

        <!-- Center: Viewport overlay (stats, mode buttons, view cube) -->
        <div class="viewport-cell" style="grid-area: viewport;">
            <div class="viewport-stats">
                <span id="fps-asset">60 FPS</span>
                <span id="tri-count-asset">SDF Evaluation</span>
            </div>
            <div class="viewport-modes">
                <button class="mode-btn active" data-mode="sdf" title="SDF Source">‚óá</button>
                <button class="mode-btn" data-mode="shell" title="Shell Mesh">‚ñ≥</button>
                <button class="mode-btn" data-mode="splat" title="Splat View">‚óè</button>
                <button class="mode-btn" data-mode="physics" title="Physics Debug">‚òê</button>
                <button class="mode-btn" onclick="clearViewportManual()" title="Clear Viewport">√ó</button>
                <button class="mode-btn" onclick="openExternalViewport()" title="Open Dedicated Viewport">‚ó≥</button>
            </div>
        </div>

        <!-- Right: Properties Panel -->
        <aside class="studio-panel properties-panel">
            <div class="resize-handle handle-left"></div>
            <header class="panel-header">
                <h2>Properties</h2>
            </header>
            <div id="property-editor" class="panel-content property-list">
                <p class="empty-state">Select a card to edit properties</p>
            </div>
        </aside>
    </main>

    <!-- Page: World Editor -->
    <main id="page-world" class="world-studio page" style="display: none;">
        <aside class="studio-panel world-panel-left" id="world-panel-left">
            <header class="panel-header">
                <h2>Chunk Map & Terrain</h2>
                <button type="button" id="world-new-btn" class="btn-sm btn-accent" title="Create new world">New
                    World</button>
            </header>
            <div class="panel-content">
                <div class="world-chunk-section">
                    <h3>Map Bricks (8m √ó 8m)</h3>
                    <div id="world-chunk-grid-wrapper" hx-get="/api/world/partials/chunks" hx-trigger="load"
                        hx-swap="innerHTML">
                        <div id="world-chunk-grid" class="chunk-grid">
                            <p class="empty-state">Loading‚Ä¶</p>
                        </div>
                    </div>
                </div>
                <div class="world-brushes-section">
                    <h3>Terrain Brushes</h3>
                    <div id="world-brush-toolbar" class="brush-toolbar"></div>
                    <div class="world-slider-group">
                        <label>Brush Size: <span id="world-brush-size-value">4.0</span>m</label>
                        <input type="range" id="world-brush-size" min="1" max="8" step="0.5" value="4">
                    </div>
                    <div class="world-slider-group">
                        <label>Strength: <span id="world-brush-strength-value">0.50</span></label>
                        <input type="range" id="world-brush-strength" min="0.1" max="1" step="0.05" value="0.5">
                    </div>
                </div>
                <div class="world-materials-section">
                    <h3>Terrain Materials</h3>
                    <div id="world-materials-list" class="world-materials-list"></div>
                </div>
            </div>
        </aside>
        <!-- Center: Viewport overlay (stats, mode buttons, view cube) -->
        <div class="viewport-cell" style="grid-area: viewport;">
            <div class="viewport-stats">
                <span id="fps-world">60 FPS</span>
                <span id="tri-count-world">SDF Evaluation</span>
            </div>
            <div class="viewport-modes">
                <button class="mode-btn active" data-mode="sdf" title="SDF Source">‚óá</button>
                <button class="mode-btn" data-mode="shell" title="Shell Mesh">‚ñ≥</button>
                <button class="mode-btn" data-mode="splat" title="Splat View">‚óè</button>
                <button class="mode-btn" data-mode="physics" title="Physics Debug">‚òê</button>
                <button class="mode-btn" onclick="clearViewportManual()" title="Clear Viewport">√ó</button>
                <button class="mode-btn" onclick="openExternalViewport()" title="Open Dedicated Viewport">‚ó≥</button>
            </div>
        </div>

        <aside class="studio-panel world-panel-right">
            <header class="panel-header">
                <h2>Entity Library</h2>
            </header>
            <div class="panel-content">
                <div class="world-entity-section">
                    <div class="world-entity-filter">
                        <select id="world-entity-filter" aria-label="Filter entities">
                            <option value="props">Props</option>
                        </select>
                    </div>
                    <div id="world-entity-grid" class="world-entity-grid"></div>
                </div>
                <button type="button" id="world-import-btn" class="world-import-btn">Import Real-World Location</button>
            </div>
        </aside>
        <div class="world-strip">
            <span id="world-strip-selection" class="world-strip-selection">No chunks selected</span>
            <div class="world-strip-actions">
                <button type="button" id="world-strip-artist" class="btn-sm">Artist Pass</button>
                <button type="button" id="world-strip-translate" class="btn-sm">Translate Node</button>
                <button type="button" id="world-strip-bake" class="btn-sm btn-accent">Bake</button>
            </div>
        </div>
    </main>

    <!-- Page: Library Browser -->
    <main id="page-library" class="library-container page">
        <header class="library-header">
            <div class="library-tabs">
                <button class="tab-btn active" data-library="geometry" hx-get="/api/library/geometry"
                    hx-target="#library-content" hx-trigger="click">
                    <span class="tab-icon">‚óá</span> Geometry
                </button>
                <button class="tab-btn" data-library="materials" hx-get="/api/library/materials"
                    hx-target="#library-content" hx-trigger="click">
                    <span class="tab-icon">‚óà</span> Materials
                </button>
                <button class="tab-btn" data-library="textures" hx-get="/api/library/textures"
                    hx-target="#library-content" hx-trigger="click">
                    <span class="tab-icon">‚ñ¶</span> Textures
                </button>
                <button class="tab-btn" data-library="audio" hx-get="/api/library/audio" hx-target="#library-content"
                    hx-trigger="click">
                    <span class="tab-icon">‚ô´</span> Audio
                </button>
                <button class="tab-btn" data-library="recipes" hx-get="/api/library/recipes"
                    hx-target="#library-content" hx-trigger="click">
                    <span class="tab-icon">‚ñ£</span> Recipes
                </button>
            </div>
            <div class="library-actions">
                <button class="btn-secondary" id="btn-upload">
                    <span class="icon">‚Üë</span> Upload
                </button>
                <button class="btn-primary" id="btn-new">
                    <span class="icon">+</span> New
                </button>
            </div>
        </header>

        <div class="library-toolbar">
            <div class="search-box">
                <input type="search" id="library-search" placeholder="Search by name or tags..."
                    hx-get="/api/library/search" hx-target="#library-content" hx-trigger="keyup changed delay:300ms"
                    hx-include="[name='library-type']" name="q">
                <input type="hidden" name="library-type" value="geometry">
            </div>
            <div class="filter-tags" id="active-tags">
                <!-- Active filter tags appear here -->
            </div>
            <div class="view-toggle">
                <button class="view-btn active" data-view="grid" title="Grid View">‚ñ¶</button>
                <button class="view-btn" data-view="list" title="List View">‚â°</button>
            </div>
        </div>

        <div class="library-sidebar">
            <div class="tag-cloud">
                <h3>Filter by Tag</h3>
                <div class="tag-category">
                    <h4>Type</h4>
                    <button class="tag-pill" data-tag="weapon">weapon</button>
                    <button class="tag-pill" data-tag="vehicle">vehicle</button>
                    <button class="tag-pill" data-tag="furniture">furniture</button>
                    <button class="tag-pill" data-tag="prop">prop</button>
                    <button class="tag-pill" data-tag="architecture">architecture</button>
                </div>
                <div class="tag-category">
                    <h4>Material</h4>
                    <button class="tag-pill" data-tag="metal">metal</button>
                    <button class="tag-pill" data-tag="wood">wood</button>
                    <button class="tag-pill" data-tag="stone">stone</button>
                    <button class="tag-pill" data-tag="plastic">plastic</button>
                    <button class="tag-pill" data-tag="fabric">fabric</button>
                </div>
                <div class="tag-category">
                    <h4>Condition</h4>
                    <button class="tag-pill" data-tag="pristine">pristine</button>
                    <button class="tag-pill" data-tag="worn">worn</button>
                    <button class="tag-pill" data-tag="damaged">damaged</button>
                    <button class="tag-pill" data-tag="rusted">rusted</button>
                </div>
            </div>
        </div>

        <div id="library-content" class="library-grid" hx-get="/api/library/geometry" hx-trigger="load">
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
        </div>
    </main>

    <div id="browser-overlay" class="browser-overlay"></div>

    <script type="module" src="/static/js/studio-navigation.js"></script>
    <script type="module" src="/static/js/studio-genai.js"></script>
    <script type="module" src="/static/js/studio-world.js"></script>
</body>

</html>